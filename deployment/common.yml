.docker:
  services:
    - name: docker:dind
  before_script:
    - set -x
    - apk add docker
    - docker --version
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

.vault:
  before_script:
    - apk add vault
    - export VAULT_ADDR=$VAULT_SERVER_URL
    - export VAULT_TOKEN="$(vault write -field=token auth/jwt/login role=$VAULT_AUTH_ROLE jwt=$CI_JOB_JWT)"

.docker-vault:
  extends:
    - .docker
  before_script:
    - !reference [.docker, before_script]
    - !reference [.vault, before_script]

.k8s-vault:
  image: alpine/k8s:1.25.3 # Image includes k8s and Helm
  before_script:
    - helm version
    # Kubernetes
    - echo $K8S_CONFIG > $K8S_CONFIG_NAME_FILE
    - kubectl --kubeconfig="$K8S_CONFIG_NAME_FILE"
    - kubectl config set-context --current --namespace="$K8S_NAMESPACE"
    - kubectl version --short
    - kubectl cluster-info
